<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Party Cards</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

  <style>
    .custom-card {
      display: flex;
      align-items: center;
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 5px 7px rgba(0, 0, 0, 0);
      border-left: 15px solid #B0B0B0;
      position: relative;
      max-width: 380px;
      height: 150px;
    }

    .icon-container {
      background: #FFC107;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-container i {
      font-size: 24px;
      color: white;
    }

    .card-content {
      flex-grow: 1;
      margin-left: 15px;
    }

    .card-content h3 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: bold;
    }

    .card-content p {
      margin: 0;
      color: gray;
      font-size: 0.9rem;
    }

    /* ì±„íŒ… ëª¨ë‹¬ ì°½ í¬ê¸° */
    .modal-dialog {
      max-width: 500px;
      height: 70vh;
    }

    .modal-content {
      height: 100%;
    }
  </style>
</head>

<body>


  <div id="tokenValue"></div>
  <div class="container mt-4">

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="/index">
          <img src="{{ url_for('static', filename='people_icon.png') }}" alt="" width="30" height="24"
            class="d-inline-block align-text-top">
          íŒŒí‹° êµ¬í•¨!
        </a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto"> <!-- ì˜¤ë¥¸ìª½ ì •ë ¬ -->
            <li class="nav-item">
              <a class="nav-link" href="/index">Home</a>
            </li>
            <li class="nav-item">
              <a id="logoutButton" class="nav-link" href="#">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>



    <div class="row align-items-center mt-3">
      <!-- ì‚¬ìš©ì ì¸ì‚¬ë§ -->
      <div class="container mt-5 mb-5">
        <div class="custom-card d-flex align-items-center p-3 shadow">
          <div class="card-content">
            <h3><span id="userGreeting" class="text-gray-700 font-semibold"></span>
              <img id="rankImage"
                src="https://i.namu.wiki/i/kfAzvKOnV8TgCe51TjU_AIdFeS4TrQMszXZ0_3aA8Yf9fMVWMMRGNG3Jce9neVsRby9Lb1KYEN6_mDRL9wP7rnhkIjm4XYj2Yg0kKzn6TOEi5busjaKB-CNLfhTkqVS5XpgcqusLMl7Dpve0Kx_7KQ.webp"
                class="rounded-circle ms-2" width="110" height="110">
            </h3>
            <span class="growth">ğŸ”¥í€˜ìŠ¤íŠ¸ë¥¼ XíšŒ í´ë¦¬ì–´í•˜ì…¨ìŠµë‹ˆë‹¤!ğŸ”¥</span>
          </div>
        </div>
      </div>

      <!-- íŒŒí‹° ìƒì„± ë²„íŠ¼ -->
      <div class="col text-end">
        <button class="btn btn-success hover:bg-blue-600 text-white w-25 h-[60px] mb-3 text-bold" data-bs-toggle="modal"
          data-bs-target="#myModal">
          íŒŒí‹° ìƒì„±
        </button>
      </div>
    </div>


    <!-- íŒŒí‹° ì¹´ë“œ ì¹´í…Œê³ ë¦¬ -->
    <div class="row mt-3">
      <div class="col">
        <form class="d-flex justify-content-center">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="category" id="eat" value="eat">
            <label class="form-check-label" for="eat">ì‹ì‚¬</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="category" id="exercise" value="exercise">
            <label class="form-check-label" for="exercise">ìš´ë™</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="category" id="study" value="study">
            <label class="form-check-label" for="study">ìŠ¤í„°ë””</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="category" id="etc" value="etc">
            <label class="form-check-label" for="etc">ê¸°íƒ€</label>
          </div>
        </form>
      </div>
    </div>


    <hr style="border: solid 10px red;">
    <!-- ëª¨ë‹¬ -->
    <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalLabel">ì •ë³´ ì…ë ¥</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="title" class="form-label">ì œëª©:</label>
                <input type="text" class="form-control" id="title" name="title" required>
              </div>
              <div class="mb-3">
                <label for="name" class="form-label">ì¹´í…Œê³ ë¦¬:</label>
                <select class="form-control" id="name" name="name" required>
                  <option value="eat" id="eat">ì‹ì‚¬</option>
                  <option value="exercise" id="exercise">ìš´ë™</option>
                  <option value="study" id="study">ìŠ¤í„°ë””</option>
                  <option value="etc" id="etc">ê¸°íƒ€</option>

                </select>
              </div>
              <div class="mb-3">
                <label for="content" class="form-label">ë‚´ìš©:</label>
                <textarea class="form-control" id="content" name="content" required></textarea>
              </div>
              <div class="mb-3">
                <label for="date" class="form-label">ì¼ì‹œ:</label>
                <input type="datetime-local" class="form-control" id="date" name="date" required>
              </div>
              <div class="mb-3">
                <label for="participants" class="form-label">ì¸ì›:</label>
                <input type="number" class="form-control" id="participants" name="participants" required>
              </div>
              <!-- post ë²„íŠ¼ í•¨ìˆ˜ ê±¸ì–´ì£¼ê¸°ê¸° -->
              <button type="submit" class="btn btn-primary" id="postPtData">ì œì¶œ</button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <div class="row" id="card-box">
      <div class="col-md-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between">
            <span class="badge bg-success">Health</span>
            <span class="text-muted"><i class="bi bi-people"></i> 3/5</span>
          </div>
          <div class="card-body">
            <h5 class="card-title">Morning Workout Group</h5>
            <div class="d-flex align-items-center mb-2">
              <small class="text-muted">Founded by Alex Kim</small>
            </div>
            <p class="card-text">Join us for morning workouts including jogging, stretching, and basic strength
              training. All fitness levels welcome!</p>
            <div class="d-flex text-muted small mb-3">
              <span><i class="bi bi-calendar"></i> Mon, Wed, Fri</span>
              <span class="ms-3"><i class="bi bi-clock"></i> 7:00 AM</span>
            </div>
            <button class="btn btn-primary w-100" id="joinBtn">Join Party</button>
          </div>
        </div>
      </div>

    </div>

  </div>
  </div>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js"></script>


  <script>
    const token = sessionStorage.getItem('token');
    // localStorage -> sessionStorage
    tokenob = JSON.parse(sessionStorage.getItem('userdata'));

    const UserName = tokenob.user_name;
    const partyCode = tokenob.user_cord;




    // post í•˜ë©° íŒŒí‹°ì˜ ë‚´ìš©ì„ ë³´ë‚´ëŠ” ë²„íŠ¼ì˜ ë³€ìˆ˜
    const $postPtBtn = document.querySelector('#postPtData');
    const $joinBtn = document.querySelector('#joinBtn');
    const $title = document.querySelector('#title');
    const $category = document.querySelector('#name');
    const $content = document.querySelector('#content');
    const $date = document.querySelector('#date');
    const $participants = document.querySelector('#participants');
    const $cardBox = document.querySelector('#card-box');

    $postPtBtn.addEventListener('click', () => postPtData());

    document.addEventListener("DOMContentLoaded", function () {
      let result = [];
      fetch("http://127.0.0.1:5000/lodingdata")
        .then((response) => response.json())
        .then((data) => {

          if (data && data.length > 0) {
            for (let i = 0; i < data.length; i++) {
              let meetingTime = formatDateTime(data[i].date_give);
              addparty(data[i].category_give, data[i].partparticipants_give, data[i].title_give,
                data[i].partymaneserName, data[i].partymanaser_cord, data[i].content_give, meetingTime, data[i].userArr, data[i]._id, data[i].manager_count);
              console.log(data[i]);
            }
          }
        }).catch((error) => console.error("ì—ëŸ¬ë°œìƒ", error))
    });


    function addparty(category, participants, title, partyName, partyCord, content, date, memberArr, _id, managerCount) {

      let checkCode = {
        check: false,
        index: 0
      }

      for (let i = 0; i < memberArr.length; i++) {
        if (partyCode === memberArr[i]) {
          checkCode.check = true;
          checkCode.index = i
          break;
        }
      }

      if (checkCode.check) {
        let currentParticipants = memberArr.length + 1; // í˜„ì¬ ì°¸ê°€ì ìˆ˜
        let isFull = currentParticipants >= participants; // ìµœëŒ€ ì¸ì› ì—¬ë¶€
        let managerRankImg = getRankImgUrl(managerCount);
        let partyCard = `
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span class="badge bg-success">${category}</span>
                    <span class="badge bg-warning text-black">íŒŒí‹° ì°¸ì—¬ ì¤‘!</span>
                    <span class="text-muted"><i class="bi bi-people"></i>${(memberArr.length + 1)}/${participants}</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <div class="d-flex align-items-center mb-2">
                        <small class="text-muted">${partyName} ${partyCord}
                        <img src="${managerRankImg}" alt="ë­í¬ì´ë¯¸ì§€" style="width: 30px; height: 30px; margin-left: 5px;">
                        </small>
                    </div>
                    <p class="card-text">${content}</p>
                    <div class="d-flex text-muted small mb-3">
                        <span><i class="bi bi-calendar"></i> ì˜ˆì •ì‹œê°„: ${date}</span>
                        <span class="ms-3"><i class="bi bi-clock"></i></span>
                    </div>
                      <div  class="d-flex justify-content-between">
                      <button class="btn btn-danger w-50 me-2" id="deleteBtn">íƒˆí‡´í•˜ê¸°</button>
                      <button class="btn btn-secondary chat-btn w-50" data-bs-toggle="modal" data-bs-target="#chatModal"><i class="bi bi-chat-left-quote-fill"></i></button>                     
                </div>
            </div>
            `;

        const borderColor = getRankColor(managerCount);
        const cardElement = document.createElement("div");
        cardElement.innerHTML = partyCard;
        cardElement.className = "col-md-4";
        const cardInner = cardElement.querySelector(".card");
        if (cardInner) {
          cardInner.style.border = `6px solid ${borderColor}`;
        }
        // íŒŒí‹°ì¥ í…Œë‘ë¦¬ ì¶”ê°€!

        const $deleteBtn = cardElement.querySelector('#deleteBtn');
        $deleteBtn.setAttribute("data-party-id", _id);
        $deleteBtn.addEventListener("click", function () {
          quitParty(checkCode.index, partyCord);
        });


        $cardBox.appendChild(cardElement);
        return;
      }

      if (partyCode === partyCord) {
        let currentParticipants = memberArr.length + 1; // í˜„ì¬ ì°¸ê°€ì ìˆ˜
        let isFull = currentParticipants >= participants; // ìµœëŒ€ ì¸ì› ì—¬ë¶€
        let managerRankImg = getRankImgUrl(managerCount);  // ë­í¬ ì´ë¯¸ì§€ URL
        let managerCard = `
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span class="badge bg-success">${category}</span>
                    <span class="badge bg-primary">ë‚´ê°€ íŒŒí‹° ë¦¬ë”! </span>
                    <span class="text-muted"><i class="bi bi-people"></i>${(memberArr.length + 1)} / ${participants}</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <div class="d-flex align-items-center mb-2">
                        <small class="text-muted">${partyName} ${partyCord}
                        <img src="${managerRankImg}" alt="ë­í¬ì´ë¯¸ì§€" style="width: 30px; height: 30px; margin-left: 5px;">
                        </small>
                    </div>
                    <p class="card-text">${content}</p>
                    <div class="d-flex text-muted small mb-3">
                        <span><i class="bi bi-calendar"></i> ì˜ˆì •ì‹œê°„: ${date}</span>
                        <span class="ms-3"><i class="bi bi-clock"></i></span>
                    </div>
                        <div  class="d-flex justify-content-between">
                        <button class="btn btn-danger w-50 me-2" id="deleteBtn">ì‚­ì œí•˜ê¸°</button>
                        <button class="btn btn-secondary chat-btn w-50" data-bs-toggle="modal" data-bs-target="#chatModal"><i class="bi bi-chat-left-quote-fill"></i></button>
                </div>
            </div>
            `;
        const borderColor = getRankColor(managerCount);
        const cardElement = document.createElement("div");
        cardElement.innerHTML = managerCard; // â† ì¶”ê°€!
        cardElement.className = "col-md-4";
        const cardInner = cardElement.querySelector(".card");
        if (cardInner) {
          cardInner.style.border = `6px solid ${borderColor}`;
        }
        // íŒŒí‹°ì¥ í…Œë‘ë¦¬ ì¶”ê°€!

        const $deleteBtn = cardElement.querySelector('#deleteBtn');
        $deleteBtn.setAttribute("data-party-id", _id);
        $deleteBtn.addEventListener("click", function () {
          deleteParty(this);
        });

        $cardBox.appendChild(cardElement);
        return;

      } else {
        let currentParticipants = memberArr.length + 1; // í˜„ì¬ ì°¸ê°€ì ìˆ˜
        let isFull = currentParticipants >= participants; // ìµœëŒ€ ì¸ì› ì—¬ë¶€
        let managerRankImg = getRankImgUrl(managerCount);
        let card = `         
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span class="badge bg-success">${category}</span>
                    <span class="text-muted"><i class="bi bi-people"></i>${(memberArr.length + 1)}/${participants}</span>
                </div>
                <div class="card-body">
                    <h5 class="card-title">${title}</h5>
                    <div class="d-flex align-items-center mb-2">
                        <small class="text-muted">${partyName} ${partyCord}
                        <img src="${managerRankImg}" alt="ë­í¬ì´ë¯¸ì§€" style="width: 30px; height: 30px; margin-left: 5px;">
                        </small>
                    </div>
                    <p class="card-text">${content}</p>
                    <div class="d-flex text-muted small mb-3">
                        <span><i class="bi bi-calendar"></i> ì˜ˆì •ì‹œê°„: ${date}</span>
                        <span class="ms-3"><i class="bi bi-clock"></i></span>
                    </div>
                    <button class="btn btn-primary w-100" id="joinBtn" ${isFull ? " disabled" : ""}>
                      ${isFull ? "ê°€ë“ì°¸" : "ì°¸ì„í•˜ê¸°"}
                    </button>                 
                </div>
            </div>`

        const borderColor = getRankColor(managerCount);
        const cardElement = document.createElement("div");
        cardElement.innerHTML = card;
        cardElement.className = "col-md-4";

        const cardInner = cardElement.querySelector(".card");
        if (cardInner) {
          cardInner.style.border = `6px solid ${borderColor}`;
        }
        // íŒŒí‹°ì¥ í…Œë‘ë¦¬ ì¶”ê°€!

        let joinButton = cardElement.querySelector("#joinBtn"); // ë²„íŠ¼ ì„ íƒ
        if (joinButton && !isFull) {
          joinButton.addEventListener("click", () => joinParty(partyCord));
        }
        
        $cardBox.appendChild(cardElement);
      }
    }

    function quitParty(index, partyCode) {
      fetch("http://127.0.0.1:5000/quitParty", {
        method: "POST",
        headers: {
          "Content-Type": "application/json", // ìš”ì²­ í—¤ë”
          "Authorization": sessionStorage.getItem("token"), // í† í° ì¶”ê°€

        },
        body: JSON.stringify({
          partyCode: partyCode,
          index: index,

        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.result) {
            window.location.reload();
            console.log(data.result);

          } else {
            console.log("ì‹¤íŒ¨");
          }
        })
        .catch((error) => console.error("ì—ëŸ¬ë°œìƒ", error));
    }


    function joinParty(partyCord_give) {
      fetch("http://127.0.0.1:5000/joinParty", {
        method: "POST",
        headers: {
          "Content-Type": "application/json", // ìš”ì²­ í—¤ë”
          "Authorization": sessionStorage.getItem('token')  // í† í° ì¶”ê°€
        },
        body: JSON.stringify({
          partyCord_give: partyCord_give,
          party_member: UserName,
          partymember_cord: partyCode,

        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.result === "success") {
            console.log(" ì°¸ê°€ ì„±ê³µ!");
            location.reload(); // ìƒˆë¡œê³ ì¹¨
            const participantText = document.querySelector(`#party-${partyCord_give} .participant-count`).textContent;
            const [currentCount, maxCount] = participantText.split('/').map(Number);
            updateParticipantCount(partyCord_give, currentCount + 1, maxCount);
          }
          else if (data.result === "full") {
            console.log("íŒŒí‹° ê°€ë“ì°¸!");
            alert("í•´ë‹¹ íŒŒí‹°ëŠ” ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!");
          }
          else {
            console.log("ì°¸ê°€ ì‹¤íŒ¨:", data.message);
          }
        })
        .catch(error => console.error("ì—ëŸ¬ ë°œìƒ", error));
    }

    function deleteParty(buttonElement) {
      const partyId = buttonElement.getAttribute("data-party-id");
      console.log("ğŸ—‘ï¸ ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨, ì „ë‹¬ëœ íŒŒí‹° ID:", partyId);  // âœ… ì‚­ì œ ìš”ì²­ ì „ ID í™•ì¸

      if (!partyId) {
        console.error("âŒ íŒŒí‹° IDê°€ ì—†ìŠµë‹ˆë‹¤! ì‚­ì œ ìš”ì²­ ì¤‘ë‹¨");
        return;
      }

      fetch("http://127.0.0.1:5000/deleteParty", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": sessionStorage.getItem('token')  // âœ… í† í° í¬í•¨
        },
        body: JSON.stringify({
          partyId: partyId  // âœ… ì„œë²„ì— ì „ì†¡ë˜ëŠ” ë°ì´í„° í™•ì¸
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("ğŸ› ï¸ ì„œë²„ ì‘ë‹µ:", data);  // âœ… ì„œë²„ ì‘ë‹µ í™•ì¸
          if (data.result === "success") {
            console.log("âœ… ì‚­ì œ ì„±ê³µ!");
            window.location.reload();
          } else {
            console.error("âŒ ì‚­ì œ ì‹¤íŒ¨:", data.msg);
          }
        })
        .catch((error) => console.error("âŒ ì‚­ì œ ì¤‘ ì—ëŸ¬ ë°œìƒ", error));
    }

    function postPtData() {
      const dateInput = $date.value; // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë‚ ì§œ
      const formattedDate = dateInput.replace(/[-:T]/g, ''); // '-'ì™€ ':' ë° 'T'ë¥¼ ì œê±°
      const date_give = parseInt(formattedDate, 10); // ë¬¸ìì—´ì„ ì •ìˆ˜ë¡œ ë³€í™˜



      fetch("http://127.0.0.1:5000/postPtdata", {
        method: "POST",
        headers: {
          "Content-Type": "application/json", // ìš”ì²­ í—¤ë”
          "Authorization": sessionStorage.getItem('token')  // í† í° ì¶”ê°€
        },
        body: JSON.stringify({
          title_give: $title.value,
          category_give: $category.value,
          content_give: $content.value,
          date_give: date_give,
          partparticipants_give: $participants.value,
          name_give: UserName,
          partyCord_give: partyCode,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.result) {
            window.location.reload();
            console.log("ì„±ê³µ");
          } else if (data.result === false) {
            alert("ì„¸ ê°œ ì´ìƒì˜ íŒŒí‹°ëŠ” ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            console.log("ì‹¤íŒ¨");
          }
        })
        .catch((error) => console.error("ì—ëŸ¬ë°œìƒ", error));
    }



    // Logout ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById("logoutButton").addEventListener("click", () => {
      // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë°ì´í„° ì‚­ì œ
      sessionStorage.clear(); // ëª¨ë“  ì„¸ì…˜ì…˜ ì €ì¥ì†Œ ë°ì´í„° ì‚­ì œ
      // ë˜ëŠ” íŠ¹ì • í‚¤ë§Œ ì‚­ì œí•˜ë ¤ë©´ ì•„ë˜ì²˜ëŸ¼ ì‚¬ìš©
      // localStorage.removeItem("token");

      // ë¡œê·¸ì•„ì›ƒ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì˜ˆ: ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™)
      window.location.href = "/login"; // ë¡œê·¸ì¸ í˜ì´ì§€ ê²½ë¡œë¡œ ë³€ê²½
    });


    //<!-- userName ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤ ê¸°ëŠ¥ Greeting ..-->
    document.addEventListener("DOMContentLoaded", () => {
      // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ "token" í‚¤ì˜ ê°’ì„ ê°€ì ¸ì˜´
      const token = sessionStorage.getItem('token');
      const userData = JSON.parse(sessionStorage.getItem('userdata'));
      // localStorage -> sessionStorage

      // user_nameê³¼ user_codeë¥¼ ì¶”ì¶œ
      const userName = userData.user_name;
      const userCode = userData.user_cord;

      // ì¸ì‚¬ë§ í‘œì‹œ
      const greetingElement = document.getElementById("userGreeting");
      greetingElement.innerText = `${userName}(${userCode})`;
    });

    // ìµœì‹ í™”ëœ count ê°’ì„ ë°›ì•„ì˜¤ëŠ” í•¨ìˆ˜
    function updateUserCount() {
      fetch("http://127.0.0.1:5000/getUserData", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          //        "Authorization": localStorage.getItem('token')
          "Authorization": sessionStorage.getItem('token')
          //ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ë¡œ ë³€ê²½ê²½

        }
      })
        .then(response => response.json())
        .then(data => {
          // í€˜ìŠ¤íŠ¸ í´ë¦¬ì–´ íšŸìˆ˜ ì—…ë°ì´íŠ¸
          const growthElement = document.querySelector(".growth");
          growthElement.innerText = `ğŸ”¥í€˜ìŠ¤íŠ¸ë¥¼ ${data.count}íšŒ í´ë¦¬ì–´í•˜ì…¨ìŠµë‹ˆë‹¤!ğŸ”¥`;
          // ì¹´ìš´íŠ¸ í™•ì¸ í›„ ë“±ê¸‰ì— ë§ëŠ” í…Œë‘ë¦¬ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
          updateRankDisplay(data.count);
        })
        .catch(error => console.error("Error fetching user data:", error));
    }
    // ìµœì´ˆ count ì—…ë°ì´íŠ¸ í˜¸ì¶œ, 30ì´ˆ ë§ˆë‹¤ ìµœì‹ í™” í•˜ê¸° -> íŒŒí‹° í™œë™ ë²„íŠ¼ í´ë¦­í•˜ë©´ ë°”ë¡œ ë°˜ì˜ë˜ê²Œ ë°”ê¿€ê¹Œ ìƒê°ì¤‘...
    updateUserCount();
    setInterval(updateUserCount, 30000);

    function getRankColor(count) {
      if (count === 0) return "#333537";             // ì–¸ë­
      else if (count >= 1 && count <= 2) return "#706260"; // ì•„ì´ì–¸
      else if (count >= 3 && count <= 4) return "#5b3e38"; // ë¸Œë¡ ì¦ˆ
      else if (count >= 5 && count <= 7) return "#C0C0C0"; // ì‹¤ë²„
      else if (count >= 8 && count <= 10) return "#FFD700"; // ê³¨ë“œ
      else if (count >= 11 && count <= 13) return "#6db0a7"; // í”Œë ˆí‹°ë„˜
      else if (count >= 14 && count <= 17) return "#1089d2"; // ë‹¤ì´ì•„ëª¬ë“œ
      else if (count >= 18 && count <= 20) return "#c64def"; // ë§ˆìŠ¤í„°
      else if (count >= 21 && count <= 24) return "#db0f27"; // ê·¸ëœë“œë§ˆìŠ¤í„°
      else if (count >= 25) return "#6ee4f7";              // ì±Œë¦°ì €
      else return "#333537"; // ê¸°ë³¸ ìƒ‰ìƒ (ì–¸ë­)
    }

    function getRankImgUrl(count) {
      // ì–¸ë­
      if (count === 0) {
        return "https://i.namu.wiki/i/kfAzvKOnV8TgCe51TjU_AIdFeS4TrQMszXZ0_3aA8Yf9fMVWMMRGNG3Jce9neVsRby9Lb1KYEN6_mDRL9wP7rnhkIjm4XYj2Yg0kKzn6TOEi5busjaKB-CNLfhTkqVS5XpgcqusLMl7Dpve0Kx_7KQ.webp";
      }
      // ì•„ì´ì–¸
      else if (count >= 1 && count <= 2) {
        return "https://i.namu.wiki/i/M3K-UvA8XXrblJLXfMRyoKzjBYLm3TewzTLS56syvZpMZijb53_8B-zjE9a5n1FG0v781GZjV7yFdMsNlF6oI7O404yjSl6Lq6YFp0eljDuyid9SrMj4AYJSey8dMfJyE4_DOhyCYiYDOig2NLT_Jw.webp";
      }
      // ë¸Œë¡ ì¦ˆ
      else if (count >= 3 && count <= 4) {
        return "https://i.namu.wiki/i/VjAt4AR7-YybDF5t0OcZOH0AXNoUeiYJ16HKZVbMHSbWZR-QNfdwYNdZOaGoQACeq489qNc1NGrvibSrq_H3psz3FsX7Fno5cNgdlVI-H72AIXc8SauLZ3dDmEIgEl8ex0dMT_B4PoA1FmSqQX-LHA.webp";
      }
      // ì‹¤ë²„
      else if (count >= 5 && count <= 7) {
        return "https://i.namu.wiki/i/JDJdUsMT5i7pCBbk9-MnTbW7HmuLh869BS1YAsvP2yvq9xyVbA--7-Yh7dNaANxB1AUO_WQ6vPRXa14qHIfnA1jPSa6dhmCLsYtILJfrIPyIMqaE7SicC15Lm3BFbOTRSIgvbPxZKx34rs-igq_Z0Q.webp";
      }
      // ê³¨ë“œ
      else if (count >= 8 && count <= 10) {
        return "https://i.namu.wiki/i/KqTKVeiodhzX6Dytg8hJaLvXwnwEHBWKUgoeu_Op68FNbKZHLQ9d9vJo_ox8uKk66NhL7VNGXPZz3eMwkl4KfA5Ls2IpzXMgWA_PRol8Xb5kiuKFcr1UK7OaXmkSXtouBz39yntO3aXSkFBeZIEtRg.webp";
      }
      // í”Œë ˆí‹°ë„˜
      else if (count >= 11 && count <= 13) {
        return "https://i.namu.wiki/i/gP_x4dW-gOM3dQhYVSl-vlaD0iK3XTxrYNgZqIeSHcPGsSpOb6tHizDWdXD8UrDx5buuE9TJWgxsWALxN-E6BYf434roJ8doUutYox5YPgSud40tgEDr-Nd-6SxhFIEVpNl4BVSn_UbgPSHqx3Wm5A.webp";
      }
      // ë‹¤ì´ì•„ëª¬ë“œ
      else if (count >= 14 && count <= 16) {
        return "https://i.namu.wiki/i/43pIN748vJtG1nYSKj8FR0Xm0GVXI9SzC-pdabd8emqv8cxJX7MdAZjFPivet21xsDbnvCWrLwYp7bWsOTu8Ncc9GVhq16jv5JYjy4hwrJXaY6XD__uqLNhzTTwNJTKZvieDQLj8KwsFQibSUjelMw.webp";
      }
      // ë§ˆìŠ¤í„°
      else if (count >= 17 && count <= 20) {
        return "https://i.namu.wiki/i/K_yzQ-ZLlGI-Bb8ZinWDbFG905HJOl-KI984ZfYZixPtf690vW6638_aLE5wo4Gu3qvTp_DHguWDw9nRjvPkpph9XiCw3g-fZaB1qsH2Y15WU9Yc730PQq-9GJxkZl6Xr_CQAMhZGQfnMtW6Oxn8Iw.webp";
      }
      // ê·¸ëœë“œë§ˆìŠ¤í„°
      else if (count >= 21 && count <= 24) {
        return "https://i.namu.wiki/i/lDhZeMTQmeOc4PJFAnDPfXsBdKCY_yOrLrmAkwfYOZNG9uMF-4RsOdVaKnXbAegwl5FR1lvKfHGdfY2pon8II8L2W31WdKLN5iTvRFExF6p70PWPvS-X_ZCNWbtHWvPlmuMAd8Q7n7lyskDhrW78UA.webp";
      }
      // ì±Œë¦°ì €
      else if (count >= 25) {
        return "https://i.namu.wiki/i/E0G5Aud-0N2extBFUz9sMlR8i9GOjmoS5aLc03d1OKnQKseaWLgmL6vN7Xu3nPRKOohY0huSiG1KAW-0yfYmXuft7OYXt2rR2KEvC-qHf3GbxZVQXYxUXTRsCHy04KKbffwn2SSheCKu6U_Vd1vbuA.webp";
      }

      // ê¸°ë³¸ê°’(ì–¸ë­ë­)
      return "https://i.namu.wiki/i/kfAzvKOnV8TgCe51TjU_AIdFeS4TrQMszXZ0_3aA8Yf9fMVWMMRGNG3Jce9neVsRby9Lb1KYEN6_mDRL9wP7rnhkIjm4XYj2Yg0kKzn6TOEi5busjaKB-CNLfhTkqVS5XpgcqusLMl7Dpve0Kx_7KQ.webp";
    }

    function updateRankDisplay(count) {
      const color = getRankColor(count);
      const userCard = document.querySelector('.custom-card');
      if (userCard) {
        userCard.style.borderLeft = `15px solid ${color}`;
      }
      const userImg = document.querySelector('#rankImage');
      if (userImg) {
        userImg.src = getRankImgUrl(count);
      }
    }

    function formatDateTime(number) {
      // ì •ìˆ˜ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
      const numberStr = number.toString();

      // ë…„ë„ ì œì™¸í•˜ê³  ë‚˜ë¨¸ì§€ ë¶€ë¶„ ì¶”ì¶œ
      const monthDayTime = numberStr.slice(4); // '03140607'

      // ì›”, ì¼, ì‹œ, ë¶„ìœ¼ë¡œ ë‚˜ëˆ„ê¸°
      const month = monthDayTime.slice(0, 2);  // '03'
      const day = monthDayTime.slice(2, 4);    // '14'
      const hour = monthDayTime.slice(4, 6);   // '16'
      const minute = monthDayTime.slice(6, 8);  // '07'

      // ìµœì¢… ë¬¸ìì—´ ìƒì„±
      return `${parseInt(month)}ì›” ${parseInt(day)}ì¼ ${parseInt(hour)}:${minute}ë¶„`;
    }

    // Add this to your existing JavaScript
    document.querySelectorAll('input[name="category"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const selectedCategory = e.target.value;

        fetch(`http://127.0.0.1:5000/categorySwitch?category=${selectedCategory}`)
          .then(response => response.json())
          .then(data => {
            document.querySelector('#card-box').innerHTML = '';
            if (data && data.length > 0) {
              data.forEach(item => {
                const managerCount = parseInt(item.manager_count);
                let meetingTime = formatDateTime(item.date_give);
                addparty(
                  item.category_give,
                  item.partparticipants_give,
                  item.title_give,
                  item.partymaneserName,
                  item.partymanaser_cord,
                  item.content_give,
                  meetingTime,
                  item.userArr,
                  item._id,
                  managerCount
                );
              });
            }
          })
          .catch(error => console.error("ì—ëŸ¬ë°œìƒ", error));
      });
    });

    function checkAndDeleteExpiredParties() {
      const now = new Date();
      const currentFormattedDate = now.toISOString().replace(/[-:T.]/g, '').slice(0, 12); // í˜„ì¬ ì‹œê°„ì„ 'YYYYMMDDHHMM' í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const currentDate = parseInt(currentFormattedDate, 10); // í˜„ì¬ ì‹œê°„ì„ ì •ìˆ˜ë¡œ ë³€í™˜

      fetch("http://127.0.0.1:5000/partyTimeOver", {
        method: "POST",
        headers: {
          "Content-Type": "application/json", // ìš”ì²­ í—¤ë”
        },
        body: JSON.stringify({
          date_give: currentDate // í˜„ì¬ ì‹œê°„ì„ ì„œë²„ë¡œ ì „ì†¡
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.length > 0) {
            console.log("ë§Œë£Œëœ íŒŒí‹°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤:", data);
          } else {
            console.log("ì‚­ì œí•  ë§Œë£Œëœ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          }
        })
        .catch((error) => console.error("ì—ëŸ¬ ë°œìƒ", error));
    }

    // 30ì´ˆë§ˆë‹¤ checkAndDeleteExpiredParties í•¨ìˆ˜ ì‹¤í–‰
    setInterval(checkAndDeleteExpiredParties, 30000);

  </script>

</body>

</html>